name: CI

on:
  push:
    branches:
      - main
      - production
    tags:
      - '*'
  pull_request: {}

concurrency:
  group: ci-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  # install_dependencies:
  #   name: üì¶ Install Dependencies
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: wyvox/action-setup-pnpm@v3
  #       with:
  #         node-version: 18.18.1

  # test:
  #   name: üïµüèª‚Äç‚ôÄÔ∏è Lint & Test
  #   runs-on: ubuntu-latest
  #   needs: [install_dependencies]
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: wyvox/action-setup-pnpm@v3
  #       with:
  #         node-version: 18.18.1
  #     - name: Lint
  #       run: pnpm lint
  #     - name: Test
  #       run: pnpm test

  build:
    name: üèóÔ∏è Build
    permissions:
      contents: write
    runs-on: ubuntu-latest
    # needs: [install_dependencies, test]
    # if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Cache
        uses: actions/cache@v3
        id: cache
        with:
          path: $RUNNER_TEMP/dependencies_cache.img
          key: ${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**/Cargo.lock') }}
      - name: Build dependencies
        id: install_deps
        if: steps.cache.outputs.cache-hit != 'true'
        uses: pguyot/arm-runner-action@v2
        with:
          base_image: https://dietpi.com/downloads/images/DietPi_RPi-ARMv8-Bullseye.7z
          cpu: cortex-a53
          bind_mount_repository: true
          image_additional_mb: 10240
          optimize_image: false
          commands: |
            # Rust complains (rightly) that $HOME doesn't match eid home
            export HOME=/root
            # Workaround to CI worker being stuck on Updating crates.io index
            export CARGO_REGISTRIES_CRATES_IO_PROTOCOL=sparse
            # Install setup prerequisites
            apt-get update -y --allow-releaseinfo-change
            apt-get upgrade -y
            apt-get autoremove -y
            apt-get install --no-install-recommends -y ca-certificates curl gnupg
            # Install rust
            curl https://sh.rustup.rs -sSf | sh -s -- -y
            . "$HOME/.cargo/env"
            # Install nodejs
            mkdir -p /etc/apt/keyrings
            curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
            NODE_MAJOR=18
            echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_$NODE_MAJOR.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list
            apt-get update
            # Install dependencies
            apt-get install --no-install-recommends -y nodejs build-essential libwebkit2gtk-4.0-dev libssl-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev
            npm install -g pnpm
            cargo install tauri-cli
            pnpm install
      - name: Move and rename image with dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mv ${{ steps.install_deps.outputs.image }} $RUNNER_TEMP/dependencies_cache.img
      - name: Build application
        uses: pguyot/arm-runner-action@v2
        with:
          base_image: file://$RUNNER_TEMP/dependencies_cache.img
          commands: |
            cargo tauri build
      - name: Upload deb bundle
        uses: actions/upload-artifact@v3
        with:
          name: Debian Bundle
          path: ${{ github.workspace }}/target/release/bundle/deb/flimmerkasten_${{github.ref_name}}_arm64.deb
